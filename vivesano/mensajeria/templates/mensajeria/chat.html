{% extends "core/base.html" %}
{% load static %}

{% block content %}

<div class="container">
    <a href="{% url 'mensajeria:conversaciones' %}" class="btn btn-secondary"

   style="
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        color: #000000b3;
        font-weight: 600;
        margin-bottom: 1rem;
   ">
    ← Volver
    </a>

    <div class="dashboard-card">

        <h1 class="dashboard-title">Chat con {{ other_user.username }}</h1>
        <p class="dashboard-welcome">
            Aquí puedes conversar con Atención al Cliente.
        </p>

        <!-- Caja del Chat -->
        <div class="card" style="margin-top: 1.5rem; padding: 1.5rem;">

            <!-- Historial de mensajes -->
            <div id="chat-box" 
                style="
                    height: 350px;
                    overflow-y: auto;
                    padding-right: 10px;
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                ">
                
                {% for msg in mensajes %}
                    {% if msg.sender.id == user.id %}
                        <!-- Mensaje enviado -->
                        <div style="
                            align-self: flex-end;
                            background: #e1f7e7;
                            color: hsl(109, 94%, 25%);
                            padding: 0.7rem 1rem;
                            max-width: 75%;
                            border-radius: 18px;
                        ">
                            {{ msg.content }}
                        </div>
                    {% else %}
                        <!-- Mensaje recibido -->
                        <div style="
                            align-self: flex-start;
                            background: #f1f1f1;
                            color: #1f2933;
                            padding: 0.7rem 1rem;
                            max-width: 75%;
                            border-radius: 18px;
                        ">
                            {{ msg.content }}
                        </div>
                    {% endif %}
                {% empty %}
                    <p>No hay mensajes todavía.</p>
                {% endfor %}
            </div>

            <!-- Formulario de envío -->
            <form method="POST" action="{% url 'mensajeria:chat' other_user.id %}">
                {% csrf_token %}

                <div class="form-group">
                    <label class="form-label">Tu mensaje</label>
                    <textarea name="content" 
                        style="
                            width: 100%;
                            min-height: 80px;
                            padding: 0.7rem 0.9rem;
                            border-radius: 12px;
                            border: 1px solid #cbd2e1;
                            font-size: 0.9rem;
                            resize: vertical;
                        "
                        required></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="margin-top: 0.6rem;">
                    Enviar mensaje
                </button>
            </form>

        </div>

    </div>
</div>

<script>
    // Cuando el chat cargue, baja automáticamente al final
    const box = document.getElementById("chat-box");
    if (box) {
        box.scrollTop = box.scrollHeight;
    }
</script>

{% endblock %}
